var sf365,__awaiter=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function a(e){try{u(s.next(e))}catch(e){i(e)}}function o(e){try{u(s.throw(e))}catch(e){i(e)}}function u(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(a,o)}u((s=s.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){var n,s,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(i){return function(o){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,s&&(r=s[2&i[0]?"return":i[0]?"throw":"next"])&&!(r=r.call(s,i[1])).done)return r;switch(s=0,r&&(i=[0,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,s=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],s=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,o])}}};!function(e){var t=function(){function e(){}return e.AreYouSure="Are you sure? edit",e}();e.ResourceStrings=t}(sf365||(sf365={})),function(e){!function(e){var t=function(){function e(e){this.settings=e,this.init()}return e.prototype.init=function(){this.Rows=ko.observableArray(),this.SeatIndex={};for(var e=0,t=0,r=0,i=this.settings.SeatMap;r<i.length;r++){var a=i[r];t=0;for(var o=new n,u=0,f=a;u<f.length;u++){var c=f[u],l=new s;l.seatclass=c,"_"!==c&&(l.name=(this.settings.RowNames?this.settings.RowNames[e]:(e+1).toString())+this.settings.ColumnNames[t],t++),o.Seats.push(l),this.SeatIndex[l.name]=l}this.Rows.push(o),e++}},e}();e.SeatsModel=t;var n=function(){return function(){this.Seats=ko.observableArray()}}();e.Row=n;var s=function(){return function(){this.passengers=ko.observableArray(),this.passengers.seat=this}}();e.Seat=s}(e.Model||(e.Model={}))}(sf365||(sf365={})),function(e){var t,n;t=e.libs||(e.libs={}),n=function(){function e(){}return e.compare=function(e,t){return e.replace("{","").replace("}","").toLowerCase()==t.replace("{","").replace("}","").toLowerCase()},e}(),t.Guid=n}(sf365||(sf365={})),function(e){var t,n;t=e.ViewModels||(e.ViewModels={}),n=function(){function t(){this.Seats=ko.observable(),this.Passengers=ko.observableArray(),this.EditedPassengers=ko.observableArray(),this.IsBusy=ko.observable(!1),this.PassengerEdited=ko.observable()}return t.prototype.canSeatAcceptPassenger=function(e,t){return!this.isSeatOccupied(e.passengers)},t.prototype.isSeatOccupied=function(e){return 0!==e().length},t.prototype.isSeatUnoccupied=function(e){return 0==e().length},t.prototype.assignSeat=function(e,t){if(!this.canSeatAcceptPassenger(e,t))throw new Error("Cannot assign seat");t.sf365_seat=e.name,this.Seats().SeatIndex[t.sf365_seat].passengers.push(t)},t.prototype.afterAssign=function(){var e=this;return function(t){e.EditedPassengers.push(t.item);var n=t.targetParent;t.item.sf365_seat=n.seat.name,e.PassengerEdited(t.item)}},t.prototype.afterUnAssign=function(){var e=this;return function(t){e.EditedPassengers.push(t.item),t.item.sf365_seat="",e.PassengerEdited(t.item)}},t.prototype.loadSeats=function(t,n){return __awaiter(this,void 0,void 0,function(){var s,r,i,a,o,u,f,c,l,d,h;return __generator(this,function(p){switch(p.label){case 0:return this.IsBusy(!0),[4,Promise.all([Xrm.WebApi.retrieveRecord("sf365_flight",t,"?$select=sf365_flightnumber&$expand=sf365_AssignedSpacecraftId($select=sf365_seatconfiguration)"),Xrm.WebApi.retrieveMultipleRecords("sf365_passenger",encodeURI('?fetchXml=<fetch version="1.0" output-format="xml-platform" mapping="logical">\n                              <entity name="sf365_passenger">\n                                <attribute name="sf365_passengerid" />\n                                <attribute name="sf365_fullname" />\n                                <attribute name="sf365_seat" />\n                                <attribute name="sf365_bookingid" />\n                                <order attribute="sf365_fullname" descending="false" />\n                                <link-entity name="sf365_booking" from="sf365_bookingid" to="sf365_bookingid" link-type="inner" alias="aa">\n                                  <filter type="and">\n                                    <condition attribute="sf365_flightid" operator="eq" uitype="sf365_flight" value="'+t+'" />\n                                  </filter>\n                                </link-entity>\n                              </entity>\n                            </fetch>'))])];case 1:for(s=p.sent(),r=s[0],i=s[1],a=r.sf365_AssignedSpacecraftId.sf365_seatconfiguration,o=a.split("\n"),u={ColumnNames:["A","B","C","D","E","F","G","H"],SeatMap:o},f=new e.Model.SeatsModel(u),this.Seats(f),c=0,l=i.entities;c<l.length;c++)null!=(d=l[c]).sf365_seat?null!=(h=f.SeatIndex[d.sf365_seat])&&this.assignSeat(h,d):e.libs.Guid.compare(d._sf365_bookingid_value,n)&&this.Passengers.push(d);return this.IsBusy(!1),[2]}})})},t.prototype.saveSeatAssignments=function(){return __awaiter(this,void 0,void 0,function(){var e,t,n,s,r;return __generator(this,function(i){switch(i.label){case 0:for(e=new Array,t=0,n=this.EditedPassengers();t<n.length;t++)s=n[t],(r={}).sf365_passengerid=s.sf365_passengerid,r.sf365_seat=s.sf365_seat,e.push(this.savePassenger(r));return this.EditedPassengers.removeAll(),[4,Promise.all(e)];case 1:return i.sent(),[2]}})})},t.prototype.savePassenger=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,Xrm.WebApi.updateRecord("sf365_passenger",e.sf365_passengerid,e)];case 1:return t.sent(),[2]}})})},t}(),t.SelectSeatsViewModel=n}(sf365||(sf365={})),function(e){var t,n;t=e.Views||(e.Views={}),n=function(){function t(){}return t.init=function(){return __awaiter(this,void 0,void 0,function(){var n,s;return __generator(this,function(r){switch(r.label){case 0:return this.vm=new e.ViewModels.SelectSeatsViewModel,n=Xrm.Page.getAttribute("sf365_flightid").getValue(),s=Xrm.Page.data.entity.getId(),[4,this.vm.loadSeats(n[0].id,s)];case 1:return r.sent(),this.vm.PassengerEdited.subscribe(function(){console.debug("edited"),parent.Xrm.Page.getAttribute("sf365_seatsmodified").setValue(Date.now().toString())}),parent.Xrm.Page.data.entity.addOnSave(t.onSave),ko.applyBindings(this.vm),[2]}})})},t.onSave=function(e){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),[4,t.vm.saveSeatAssignments()];case 1:return s.sent(),[3,3];case 2:return n=s.sent(),e.getEventArgs().preventDefault(),Xrm.Navigation.openAlertDialog({text:n.message},null),[3,3];case 3:return[2]}})})},t}(),t.SelectSeatsView=n}(sf365||(sf365={}));